<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Full Travel Gallery</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background:#f0f4f8; font-family:sans-serif; }
    header { background:#1e40af; color:#fff; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; border-bottom-left-radius:15px; border-bottom-right-radius:15px; flex-wrap:wrap; }
    #full-gallery .card { position:relative; border-radius:15px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition:.3s; }
    #full-gallery .card:hover { transform:scale(1.03); }
    .checkbox-overlay { position:absolute; top:10px; left:10px; background:#fff; padding:5px; border-radius:6px; display:none; }
    .show-checkbox .checkbox-overlay { display:block; }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <h1>Gagangiri Travel Gallery</h1>
    <div class="d-flex align-items-center gap-2">
      <!-- Dropdown for Actions -->
      <div class="dropdown">
        <button class="btn btn-warning dropdown-toggle" type="button" id="actionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          Actions
        </button>
        <ul class="dropdown-menu" aria-labelledby="actionDropdown">
          <li><a class="dropdown-item" href="#" onclick="toggleSelection('replace')"><i class="fa fa-pen me-1"></i> Replace</a></li>
          <li><a class="dropdown-item" href="#" onclick="toggleSelection('delete')"><i class="fa fa-trash me-1"></i> Delete</a></li>
        </ul>
      </div>

      <!-- Exit / Back to Home -->
      <button class="btn btn-secondary" onclick="window.location.href='index.html'"><i class="fa fa-home me-1"></i> Back to Home</button>

      <!-- Confirm / Cancel buttons (appear when action selected) -->
      <div id="action-buttons" style="display:none;" class="ms-2">
        <button class="btn btn-success me-2" onclick="confirmAction()">Confirm</button>
        <button class="btn btn-danger" onclick="cancelAction()">Cancel</button>
      </div>
    </div>
  </header>

  <!-- Hidden file input for replace -->
  <input type="file" id="replaceFile" accept="image/*" style="display:none;" />

  <!-- Main Gallery -->
  <div class="container my-4">
    <div class="row g-4" id="full-gallery"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const PASSWORD = "admin123";
    let imagesList = [];
    let currentAction = null;

    async function loadGallery() {
      const galleryContainer = document.getElementById("full-gallery");
      try {
        const res = await fetch("http://localhost:5000/gallery");
        const images = await res.json();
        imagesList = images.reverse();

        galleryContainer.innerHTML = imagesList.map(imgObj => `
          <div class="col-lg-4 col-md-6">
            <div class="card">
              <div class="checkbox-overlay">
                <input type="checkbox" class="img-check" value="${imgObj.id}">
              </div>
              <img src="http://localhost:5000${imgObj.path}" class="card-img-top" style="height:250px;object-fit:cover;">
            </div>
          </div>
        `).join('');
      } catch(err) {
        galleryContainer.innerHTML = "<p class='text-danger text-center'>Failed to load gallery</p>";
      }
    }

    function toggleSelection(action) {
      currentAction = action;
      document.getElementById("full-gallery").classList.add("show-checkbox");
      document.getElementById("action-buttons").style.display = "block";
    }

    function cancelAction() {
      currentAction = null;
      document.getElementById("full-gallery").classList.remove("show-checkbox");
      document.getElementById("action-buttons").style.display = "none";
      document.querySelectorAll(".img-check").forEach(c => c.checked = false);
    }

    async function confirmAction() {
      const selected = Array.from(document.querySelectorAll(".img-check:checked")).map(c => parseInt(c.value));
      if (selected.length === 0) { alert("No images selected!"); return; }

      if (currentAction === "delete") {
        const pwd = prompt("Enter password:");
        if (pwd !== PASSWORD) return alert("Wrong password!");
        for (let id of selected) {
          await fetch(`http://localhost:5000/gallery/${id}`, { method: "DELETE" });
        }
        alert("Deleted successfully!");
        cancelAction();
        loadGallery();
      }

      if (currentAction === "replace") {
        if (selected.length > 1) return alert("You can only replace one image at a time!");
        const fileInput = document.getElementById("replaceFile");
        fileInput.click();

        fileInput.onchange = async () => {
          const file = fileInput.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("galleryPictures", file);

          const uploadRes = await fetch("http://localhost:5000/gallery", { method: "POST", body: formData });
          const uploadData = await uploadRes.json();
          if (!uploadData.success) return alert("Upload failed!");

          const newImage = uploadData.images[0];

          await fetch(`http://localhost:5000/gallery/${selected[0]}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path: newImage.path })
          });

          alert("Image replaced successfully!");
          cancelAction();
          loadGallery();
        };
      }
    }

    loadGallery();
  </script>
</body>
</html>
